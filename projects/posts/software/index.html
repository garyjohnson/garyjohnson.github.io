<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Bluetooth Build Button, Part 5: the software - Gary’s Work in Progress</title>
<meta name="description" content="Now that v1.0 is out of the way (Part 4: v1.0 complete), we can spend some time using it day-to-day and build incremental improvements.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Gary's Work in Progress">
<meta property="og:title" content="Bluetooth Build Button, Part 5: the software">
<meta property="og:url" content="http://garyjohnson.github.io/projects/posts/software/">


  <meta property="og:description" content="Now that v1.0 is out of the way (Part 4: v1.0 complete), we can spend some time using it day-to-day and build incremental improvements.">



  <meta property="og:image" content="http://garyjohnson.github.io/images/button05/header.jpg">





  <meta property="article:published_time" content="2019-03-18T10:29:00+00:00">






<link rel="canonical" href="http://garyjohnson.github.io/projects/posts/software/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "http://garyjohnson.github.io/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Gary's Work in Progress Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Gary's Work in Progress
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/projects/">Projects</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero"
  style=" background-image: url('');"
>
  
    <img src="/images/button05/header.jpg" alt="Bluetooth Build Button, Part 5: the software" class="page__hero-image">
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Bluetooth Build Button, Part 5: the software">
    <meta itemprop="description" content="Now that v1.0 is out of the way (Part 4: v1.0 complete), we can spend some time using it day-to-day and build incremental improvements.">
    <meta itemprop="datePublished" content="2019-03-18T10:29:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Bluetooth Build Button, Part 5: the software
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>Now that <a href="/projects/posts/build-button-v1/">v1.0 is out of the way (Part 4: v1.0 complete)</a>, we can spend some time using it day-to-day and build incremental improvements.</p>

<h2 id="goals">Goals</h2>

<p>I’ve made it through a week with the build button as a daily driver of launching tests, and it works great! The battery life is surprisingly sufficient and has lasted over several workdays without a charge.</p>

<p><img src="/images/button05/daily-driver.jpg" alt="workstation" /></p>

<p>However, there are two issues I’m hoping to address via software.</p>

<p>The first is that the button indiscriminately enters <code class="language-plaintext highlighter-rouge">rake spec/n</code> when pressed via an iTerm binding. Even though I’ve been doing a lot of work in Rails projects, I also work in projects that are node.js or even Rails + webpacker, where I need to run test suites for both Ruby and Javascript. We simply need a better way to be smart about what gets run.</p>

<p>The second is that inside of Vim, there are multiple contexts I may want to trigger for test run – run the current spec, run all the specs in the current file, or run the entire test suite. I’ve been using the button to run the current spec, and falling back to key commands to execute the other cases. I want the button to handle all of this!</p>

<h2 id="bash">Bash</h2>

<p>I know that the iTerm binding is too removed from the execution context to remain. Defining this as a key binding in iTerm means that it enters this text whether I’m in vim or a bash prompt or anywhere else. So let’s delete it:</p>

<p><img src="/images/button05/iterm-binding.png" alt="iterm binding" /></p>

<p>Something that occurred to me is that being smart about the project and what test suite to run is <em>really hard</em>, if not impossible to get right. Instead, let’s start by making this purely customizable and expanding to be smart only if we must.</p>

<p>The simple idea is, let’s create a <a href="https://wiki.archlinux.org/index.php/Dotfiles">dotfile</a> per project directory that contains the command we want to run. <em>Then</em> we can build a launcher that will run what’s in the dotfile, <em>then</em> we can bind to the launcher.</p>

<p>So, an example of the dotfile (I called it <code class="language-plaintext highlighter-rouge">.button</code>):</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span><span class="w"> </span>Contents of .button:
<span class="go">rake spec</span></code></pre></figure>

<p>And our <a href="https://github.com/garyjohnson/build-button/blob/master/button-launcher/button-launcher">button-launcher script</a>, written entirely in shell script. How easy was <em>that</em>?</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="nv">FILE</span><span class="o">=</span><span class="s1">'.button'</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="nv">$FILE</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  while </span><span class="nb">read </span>p<span class="p">;</span> <span class="k">do
    </span><span class="nb">eval</span> <span class="nv">$p</span>
  <span class="k">done</span> &lt; <span class="nv">$FILE</span>
<span class="k">else
  </span><span class="nb">echo</span> <span class="s2">"No .button file found in current directory!"</span>
<span class="k">fi</span></code></pre></figure>

<p>We can symlink it into our path at <code class="language-plaintext highlighter-rouge">/usr/local/bin/</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo ln</span> <span class="nt">-s</span> &lt;full path&gt;/button-launcher /usr/local/bin/button-launcher</code></pre></figure>

<p>As it turns out, bash has a <a href="https://stackoverflow.com/questions/4200800/in-bash-how-do-i-bind-a-function-key-to-a-command">builtin <code class="language-plaintext highlighter-rouge">bind</code> command</a> that will at least let us keep it in the shell and out of vim. Thinking ahead to broader compatibility a little, I also checked <a href="https://fishshell.com/docs/current/commands.html#bind">other shells</a> to make sure they had some equivalent command.</p>

<p>So, in our <code class="language-plaintext highlighter-rouge">.bash-profile</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">bind</span> <span class="nt">-x</span> <span class="s1">'"\e6":"button-launcher"'</span></code></pre></figure>

<p>You’ll notice we changed the keybinding. As it turns out, it’s a little challenging to find an available keybinding that works in terminal and vim and doesn’t overlap with anything else. In this case, we’ve moved to <code class="language-plaintext highlighter-rouge">CTRL+ALT+6</code>, and shortly will also use <code class="language-plaintext highlighter-rouge">CTRL+ALT+7</code> and <code class="language-plaintext highlighter-rouge">CTRL+ALT+8</code> for other commands.</p>

<h2 id="vim-test">vim-test</h2>

<p>Inside of Vim / NeoVim, I use <a href="https://github.com/janko/vim-test">vim-test</a> to launch my tests, which does a nice job of being context aware.</p>

<p>Let’s start by binding the button to run the test nearest to the cursor. In <code class="language-plaintext highlighter-rouge">~/.vimrc</code>:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">nmap &lt;silent&gt;</span><span class="w"> </span>&lt;M-6&gt; :TestNearest&lt;CR&gt; </code></pre></figure>

<h2 id="extra-contexts">Extra contexts</h2>

<p>Okay! Now the button runs whatever command I want in bash, and still launches the nearest test in vim-test. Let’s add some additional contexts.</p>

<p>My thought is to be able to hold the button just a little longer to increase the scope of the tests you run. So, quick push is current test, 1s hold is current file, 2s hold is test suite (for example).</p>

<p>In our <a href="https://github.com/garyjohnson/build-button/blob/master/firmware/build-button/build-button.ino#L36">firmware</a>:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="nf">onButtonRelease</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">holdDuration</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stageLength</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">holdDuration</span> <span class="o">&lt;</span> <span class="n">stageLength</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bleKeyboard</span><span class="p">.</span><span class="n">sendStage1Key</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">holdDuration</span> <span class="o">&lt;</span> <span class="n">stageLength</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bleKeyboard</span><span class="p">.</span><span class="n">sendStage2Key</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bleKeyboard</span><span class="p">.</span><span class="n">sendStage3Key</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>These <a href="https://github.com/garyjohnson/build-button/blob/971584ccf41935df530c323840ae0f39e155f7b9/firmware/build-button/BleKeyboardApp.cpp#L14-L27">will trigger</a> <code class="language-plaintext highlighter-rouge">CTRL+ALT=6</code> through <code class="language-plaintext highlighter-rouge">8</code>, respectively.</p>

<p>Let’s wire these up in our <code class="language-plaintext highlighter-rouge">.vimrc</code>:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">nmap &lt;silent&gt;</span><span class="w"> </span>&lt;M-6&gt; :TestNearest&lt;CR&gt; 
<span class="gp">nmap &lt;silent&gt;</span><span class="w"> </span>&lt;M-7&gt; :TestFile&lt;CR&gt;
<span class="gp">nmap &lt;silent&gt;</span><span class="w"> </span>&lt;M-8&gt; :TestSuite&lt;CR&gt;</code></pre></figure>

<p>For now, let’s make sure in the shell that no matter how long we hold the button for, it fires our launcher:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">bind -x '"\e6":"button-launcher"'
bind -x '"\e7":"button-launcher"'
bind -x '"\e8":"button-launcher"'</span></code></pre></figure>

<p>Now we can fire off different scopes of test runs, although we have <em>no feedback</em> as to how long we need to hold the button. I think we can start looking forward to using the NeoPixel ring as a feedback mechanism.</p>

<h2 id="scope-creep">Scope Creep</h2>

<p>Some things we haven’t addressed yet:</p>

<ul>
  <li>There’s no feedback mechanism for how long the button is pressed.</li>
  <li>Our software solution is very focused on bash / vim in macOS. We have little clue how this will work in other environments.</li>
  <li>Setting up the software side of things is very manual and not packaged nicely.</li>
</ul>

<h2 id="a-diversion">A diversion</h2>

<p>A welcome diversion from actual progress: during a hack night, <a href="http://www.datablue.net">a buddy</a> was <a href="https://www.dobot.cc">playing with a robot arm</a> and we combined projects to create a robot that would perpetually run it’s own program using the button:</p>

<p><br /></p>
<video controls="controls" name="robot" src="/images/button05/robot.mp4" poster="/images/button05/robot-thumbnail.png" preload="auto"></video>
<p><br /></p>

<h2 id="whats-next">What’s next</h2>

<p>Every day I’m opening the button up to toggle the power switch, so it’s now my #1 priority to get that accessible on the outside of the button. Next: <a href="/projects/posts/lights-and-a-power-switch/">lights and a power switch</a></p>


        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-03-18T10:29:00+00:00">March 18, 2019</time></p>


      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=Bluetooth+Build+Button%2C+Part+5%3A+the+software%20http%3A%2F%2Fgaryjohnson.github.io%2Fprojects%2Fposts%2Fsoftware%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fgaryjohnson.github.io%2Fprojects%2Fposts%2Fsoftware%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fgaryjohnson.github.io%2Fprojects%2Fposts%2Fsoftware%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/projects/posts/build-button-v1/" class="pagination--pager" title="Bluetooth Build Button, Part 4: v1.0 complete
">Previous</a>
    
    
      <a href="/projects/posts/lights-and-a-power-switch/" class="pagination--pager" title="Bluetooth Build Button, Part 6: lights and a power switch
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/projects/posts/crashes-and-animations/" rel="permalink">Bluetooth Build Button, Part 7: crashes and animations
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Previously, we added LEDs for feedback (Part 6: lights and a power switch), and ended up with a number of problems to fix. The most blocking was an issue whe...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/projects/posts/lights-and-a-power-switch/" rel="permalink">Bluetooth Build Button, Part 6: lights and a power switch
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">With a basic software implementation completed (Part 5: the software), we can spend some time using it day-to-day and build incremental improvements.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/projects/posts/build-button-v1/" rel="permalink">Bluetooth Build Button, Part 4: v1.0 complete
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">With the rough-ins in place (Part 3: the enclosure rough-ins), we can build out the enclosure.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/projects/posts/enclosure-rough-ins/" rel="permalink">Bluetooth Build Button, Part 3: the enclosure rough-ins
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">With the core idea now functional (Part 2: the proof-of-concept), it’s time to start working on a proper enclosure.

</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 Gary's Work in Progress. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>










  </body>
</html>
